# kernel
Phase 3 of Assignment 1 from the [CS140 course](https://cs140e.sergio.bz/assignments/1-shell/).

The main OS kernel.

## `blinky` branch
Uses `Timer` in `pi::timer` to blink LED.

## `gpio` branch
Uses `Timer` in `pi::timer` and `Gpio` in `pi::gpio` to blink LED.


## Memory Alignment
To align an address downwards to the nearest alignment multiple, you want to zero out the last bits. This effectively rounds down to the nearest alignment multiple.

For an alignment of 4 bytes (`b0100`), an address is aligned in memory if the last two bits are zero.

To achieve this, subtract one from the alignment, take the bitwise negation, then `AND` that with the alignment, `addr & !(align - 1)`.

This works as along as the alignment is a power of two, or as long as `!(align & (align - 1)) == 0`.

Aligning up is the same as aligning down, except the alignment minus one is added to the address, `(addr + align - 1) & !(align - 1)`.


### Align Down Example
```
addr    = 0xFFFF;           // b1111111111111111, 65535 
align   = 1 << 2;           // b0000000000000100, 4
addr & !(align - 1) = 0xFFFF & !(0x04 - 0x01) = 0xFFFC


            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            |15 |14 |13 |12 |11 |10 | 9 | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
0xFFFF:
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+

1 << 2 = 0x04:
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+

0x04 - 1 = 0x03:
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 1 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+

!(0x03) = 0xFFFC:
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 0 | 0 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+

0xFFFF & !(0x03) = 0xFFFC:

            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 0 | 0 |
         &  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 |
            =================================================================
            | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 0 | 0 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
```

### Align Up Example
```
addr    = 0xFFFF;           // b1111111111111111, 65535 
align   = 1 << 2;           // b0000000000000100, 4
(addr + align - 1)  & !(align - 1) = (0xFFFF + 0x04 - 0x01) & !(0x04 - 0x01) = 0x10000


            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            |16 |15 |14 |13 |12 |11 |10 | 9 | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
0xFFFF:
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 0 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+

1 << 2 = 0x04:
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+

0x04 - 1 = 0x03:
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 1 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+

0xFFFF + 0x03 = 0x10002:
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+

!(0x03) = 0x1FFF9:
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 0 | 0 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+

0x10002 & !(0x03) = 0x10000:
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 |
         &  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
            | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 0 | 0 |
            =====================================================================
            | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
            +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+

```
